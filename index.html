<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Laundry Slot Booking H-8</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #f0f4ff, #e1ecff);
      margin: 0;
    }
    .container {
      max-width: 900px;
      margin: 30px auto;
      background: #fff;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    }
    h2 { text-align: center; }
    label { font-weight: 600; margin-top: 15px; display: block; }
    input, select, button {
      width: 100%;
      padding: 10px;
      margin-top: 6px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-family: 'Poppins', sans-serif;
    }
    button {
      background: #007BFF;
      color: white;
      font-weight: 600;
      border: none;
      cursor: pointer;
      margin-top: 20px;
    }
    button:hover { background: #0056b3; }
    .hidden { display: none; }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      padding: 10px;
      border-bottom: 1px solid #ddd;
      text-align: center;
    }
    th {
      background: #007BFF;
      color: white;
    }

    .live { color: green; font-weight: bold; }
    .upcoming { color: #0d6efd; font-weight: bold; }
    .completed { color: #6c757d; font-weight: bold; }

    .delete {
      background: #dc3545;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
    }
    .admin-btn {
      background: #6c757d;
      margin-top: 30px;
    }

    /* üîê Admin Modal */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal-box {
      background: #fff;
      padding: 25px;
      border-radius: 12px;
      width: 320px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    }
    .modal-box h3 {
      text-align: center;
      margin-bottom: 15px;
    }
  </style>
</head>

<body>

<!-- USER VIEW -->
<div class="container" id="userView">
  <h2>üß∫ Laundry Slot Booking H-8</h2>

  <form id="bookingForm">
    <label>Name</label>
    <input id="userName" required>

    <label>Date</label>
    <input type="date" id="bookingDate" required>

    <label>Big Washer</label>
    <select id="bigWasher"></select>

    <label>Small Washer</label>
    <select id="smallWasher"></select>

    <label>Big Dryer</label>
    <select id="bigDryer"></select>

    <label>Small Dryer</label>
    <select id="smallDryer"></select>

    <button type="submit">‚úÖ Book Slot</button>
  </form>

  <button class="admin-btn" id="adminLoginBtn">üîê Admin Login</button>
</div>

<!-- ADMIN VIEW -->
<div class="container hidden" id="adminView">
  <h2>üõ†Ô∏è Admin Dashboard</h2>

  <label>Select Date</label>
  <input type="date" id="adminDate">

  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Machine</th>
        <th>Slot</th>
        <th>Status</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="adminTable"></tbody>
  </table>

  <button class="admin-btn" onclick="logoutAdmin()">‚¨Ö Back to User</button>
</div>

<!-- üîê PASSWORD MODAL -->
<div class="modal hidden" id="passwordModal">
  <div class="modal-box">
    <h3>Admin Login</h3>
    <input
      type="password"
      id="adminPassword"
      placeholder="Enter admin password"
    />
    <button id="confirmAdminLogin">Login</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
import {
  getDatabase, ref, push, get, child,
  update, remove
} from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBfU-aqLYHF_X0Rwv0WqZtB_M0cdacoDg",
  authDomain: "launry-booking-h8.firebaseapp.com",
  databaseURL: "https://launry-booking-h8-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "launry-booking-h8",
  storageBucket: "launry-booking-h8.appspot.com",
  messagingSenderId: "485927717258",
  appId: "1:485927717258:web:be15abc9f8cd281846e073"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const today = new Date().toLocaleDateString("en-CA");
bookingDate.value = today;
bookingDate.min = today;
adminDate.value = today;

const fields = ["bigWasher","smallWasher","bigDryer","smallDryer"];

const timeSlots = Array.from({length:24},(_,i)=>{
  const s = String(i).padStart(2,"0")+":00";
  const e = String((i+1)%24).padStart(2,"0")+":00";
  return `${s} - ${e}`;
});

function populateSlots(booked={}) {
  fields.forEach(f=>{
    const s=document.getElementById(f);
    s.innerHTML='<option value="">-- Select Slot --</option>';
    timeSlots.forEach(slot=>{
      if(!booked[f]?.includes(slot)){
        const o=document.createElement("option");
        o.value=o.textContent=slot;
        s.appendChild(o);
      }
    });
  });
}
populateSlots();

bookingForm.addEventListener("submit",async e=>{
  e.preventDefault();
  const data={
    name:userName.value.trim(),
    date:bookingDate.value,
    bigWasher:bigWasher.value,
    smallWasher:smallWasher.value,
    bigDryer:bigDryer.value,
    smallDryer:smallDryer.value
  };

  const snap=await get(child(ref(db),`bookings/${data.date}`));
  if(snap.exists()){
    for(const b of Object.values(snap.val())){
      for(const f of fields){
        if(data[f] && b[f]===data[f]){
          alert("‚ö†Ô∏è Slot already booked");
          return;
        }
      }
    }
  }

  await push(ref(db),`bookings/${data.date}`,data);
});

const modal = document.getElementById("passwordModal");
const adminPwdInput = document.getElementById("adminPassword");

adminLoginBtn.onclick = () => {
  modal.classList.remove("hidden");
  adminPwdInput.value = "";
  adminPwdInput.focus();
};

confirmAdminLogin.onclick = () => {
  if (adminPwdInput.value === "admin123") {
    modal.classList.add("hidden");
    userView.classList.add("hidden");
    adminView.classList.remove("hidden");
    loadAdmin();
  } else {
    alert("‚ùå Wrong password");
  }
};

window.logoutAdmin = () => {
  adminView.classList.add("hidden");
  userView.classList.remove("hidden");
};

function nowMinutes(){
  const d=new Date();
  return d.getHours()*60 + d.getMinutes();
}

async function loadAdmin(){
  adminTable.innerHTML="";
  const selectedDate = adminDate.value;
  const todayStr = today;
  const snap=await get(child(ref(db),`bookings/${selectedDate}`));
  if(!snap.exists()) return;

  for(const [key,b] of Object.entries(snap.val())){
    fields.forEach(f=>{
      if(!b[f]) return;

      const [h,m]=b[f].split(" - ")[0].split(":").map(Number);
      const slotStart = h*60 + m;

      let status, cls;
      if (selectedDate < todayStr) {
        status="COMPLETED"; cls="completed";
      } else if (selectedDate > todayStr) {
        status="UPCOMING"; cls="upcoming";
      } else {
        const now=nowMinutes();
        if (slotStart<=now && now<slotStart+60) {
          status="LIVE"; cls="live";
        } else if (slotStart+60<=now) {
          status="COMPLETED"; cls="completed";
        } else {
          status="UPCOMING"; cls="upcoming";
        }
      }

      const tr=document.createElement("tr");
      tr.innerHTML=`
        <td>${b.name}</td>
        <td>${f}</td>
        <td>${b[f]}</td>
        <td class="${cls}">${status}</td>
        <td>
          <button class="delete"
            onclick="deleteMachine('${key}','${f}')">
            Delete
          </button>
        </td>`;
      adminTable.appendChild(tr);
    });
  }
}

window.deleteMachine = async (key,f)=>{
  if(!confirm(`Delete ${f} booking?`)) return;

  const base=ref(db,`bookings/${adminDate.value}/${key}`);
  await update(base,{[f]:""});

  const snap=await get(base);
  if(snap.exists()){
    const v=snap.val();
    if(fields.every(x=>!v[x])){
      await remove(base);
    }
  }
  loadAdmin();
};

adminDate.addEventListener("change",loadAdmin);
</script>

</body>
</html>
