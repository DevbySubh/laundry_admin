<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Laundry Slot Booking H-8</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #f0f4ff, #e1ecff);
      margin: 0;
    }

    .page {
      display: flex;
      gap: 20px;
      max-width: 1300px;
      margin: auto;
      padding: 20px;
    }

    .container, .side-metrics {
      background: #fff;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    }

    .container { flex: 1; }

    .side-metrics {
      width: 320px;
      position: sticky;
      top: 20px;
      height: fit-content;
    }

    h2, h3 { margin-top: 0; }

    label { font-weight: 600; margin-top: 15px; display: block; }

    input, select, button {
      width: 100%;
      padding: 10px;
      margin-top: 6px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-family: 'Poppins', sans-serif;
    }

    button {
      background: #007BFF;
      color: white;
      font-weight: 600;
      border: none;
      cursor: pointer;
      margin-top: 20px;
    }

    .admin-btn { background: #6c757d; }

    .metric {
      background: #f8f9fa;
      padding: 12px;
      border-radius: 10px;
      margin-bottom: 12px;
      font-size: 0.95rem;
    }

    ol { padding-left: 20px; margin: 0; font-size: 0.9rem; }

    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #212529;
      color: white;
      padding: 12px 18px;
      border-radius: 10px;
      font-size: 0.95rem;
      box-shadow: 0 8px 20px rgba(0,0,0,0.3);
      z-index: 999;
    }

    .toast.hidden { opacity: 0; pointer-events: none; }
  </style>
</head>

<body>

<div class="page">

  <!-- USER VIEW -->
  <div class="container">
    <h2>üß∫ Laundry Slot Booking H-8</h2>

    <form id="bookingForm">
      <label>Name</label>
      <input id="userName" required>

      <label>Date</label>
      <input type="date" id="bookingDate" required>

      <label>Big Washer</label>
      <select id="bigWasher"></select>

      <label>Small Washer</label>
      <select id="smallWasher"></select>

      <label>Big Dryer</label>
      <select id="bigDryer"></select>

      <label>Small Dryer</label>
      <select id="smallDryer"></select>

      <button type="submit">‚úÖ Book Slot</button>
    </form>
  </div>

  <!-- SIDE METRICS -->
  <div class="side-metrics">
    <h3>üèÜ Laundry Legends</h3>

    <div class="metric" id="topMonth">üèÖ Top Booker (This Month): ‚Äî</div>
    <div class="metric" id="topAllTime">üåü All-Time Legend: ‚Äî</div>

    <h4>üìÖ Top 10 ‚Äì This Month</h4>
    <ol id="top10Month"></ol>

    <h4>üåü Top 10 ‚Äì All Time</h4>
    <ol id="top10All"></ol>
  </div>

</div>

<div id="insightToast" class="toast hidden"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
import { getDatabase, ref, push, get } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

/* Firebase */
const firebaseConfig = {
  apiKey: "AIzaSyBfU-aqLYHF_X0Rwv0WqZtB_M0cdacoDg",
  authDomain: "launry-booking-h8.firebaseapp.com",
  databaseURL: "https://launry-booking-h8-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "launry-booking-h8",
  storageBucket: "launry-booking-h8.appspot.com",
  messagingSenderId: "485927717258",
  appId: "1:485927717258:web:be15abc9f8cd281846e073"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* DOM */
const topMonthDiv = document.getElementById("topMonth");
const topAllTimeDiv = document.getElementById("topAllTime");
const top10Month = document.getElementById("top10Month");
const top10All = document.getElementById("top10All");
const toast = document.getElementById("insightToast");

/* Init */
const today = new Date().toLocaleDateString("en-CA");
const month = today.slice(0,7);
bookingDate.value = today;

const fields = ["bigWasher","smallWasher","bigDryer","smallDryer"];

/* Slots */
const timeSlots = Array.from({length:24},(_,i)=>{
  const s = String(i).padStart(2,"0")+":00";
  const e = String((i+1)%24).padStart(2,"0")+":00";
  return `${s} - ${e}`;
});

fields.forEach(f=>{
  const sel=document.getElementById(f);
  sel.innerHTML='<option value="">-- Select Slot --</option>';
  timeSlots.forEach(slot=>{
    const o=document.createElement("option");
    o.value=o.textContent=slot;
    sel.appendChild(o);
  });
});

/* Booking */
bookingForm.addEventListener("submit", async e=>{
  e.preventDefault();
  await push(ref(db,`bookings/${bookingDate.value}`),{
    name:userName.value.trim(),
    date:bookingDate.value,
    bigWasher:bigWasher.value,
    smallWasher:smallWasher.value,
    bigDryer:bigDryer.value,
    smallDryer:smallDryer.value
  });
  alert("‚úÖ Booking Successful");
  bookingForm.reset();
});

/* Metrics (BOOKING = 1 COUNT) */
async function loadMetrics(){
  const snap = await get(ref(db,"bookings"));
  if(!snap.exists()) return;

  const monthly={}, allTime={}, night={}, early={};

  Object.values(snap.val()).forEach(day=>{
    Object.values(day).forEach(b=>{
      // booking-based counts
      allTime[b.name]=(allTime[b.name]||0)+1;
      if(b.date.startsWith(month)){
        monthly[b.name]=(monthly[b.name]||0)+1;
      }

      // time-based (slot-specific)
      fields.forEach(f=>{
        if(!b[f]) return;
        const h=parseInt(b[f]);
        if(b.date.startsWith(month)){
          if(h<5) night[b.name]=(night[b.name]||0)+1;
          if(h>=5 && h<7) early[b.name]=(early[b.name]||0)+1;
        }
      });
    });
  });

  const sort=o=>Object.entries(o).sort((a,b)=>b[1]-a[1]);

  const m=sort(monthly);
  const a=sort(allTime);

  if(m[0]) topMonthDiv.innerText=`üèÖ Top Booker (This Month): ${m[0][0]} (${m[0][1]} bookings)`;
  if(a[0]) topAllTimeDiv.innerText=`üåü All-Time Legend: ${a[0][0]} (${a[0][1]} bookings)`;

  top10Month.innerHTML=m.slice(0,10).map(x=>`<li>${x[0]} ‚Äì ${x[1]}</li>`).join("");
  top10All.innerHTML=a.slice(0,10).map(x=>`<li>${x[0]} ‚Äì ${x[1]}</li>`).join("");

  const insights=[];
  if(Object.keys(night).length) insights.push(`ü¶â Night Owl: ${sort(night)[0][0]}`);
  if(Object.keys(early).length) insights.push(`üêì Early Bird: ${sort(early)[0][0]}`);

  rotateInsights(insights);
}

/* Toast rotation */
let i=0;
function rotateInsights(arr){
  if(!arr.length) return;
  setInterval(()=>{
    toast.innerText=arr[i%arr.length];
    toast.classList.remove("hidden");
    setTimeout(()=>toast.classList.add("hidden"),3500);
    i++;
  },5000);
}

loadMetrics();
</script>

</body>
</html>
