<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Laundry Slot Booking H-8</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #f0f4ff, #e1ecff);
      margin: 0;
    }
    .container {
      max-width: 900px;
      margin: 30px auto;
      background: #fff;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    }
    h2 { text-align: center; }

    label { font-weight: 600; margin-top: 15px; display: block; }

    input, select, button {
      width: 100%;
      padding: 10px;
      margin-top: 6px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-family: 'Poppins', sans-serif;
    }

    button {
      background: #007BFF;
      color: white;
      font-weight: 600;
      border: none;
      cursor: pointer;
      margin-top: 20px;
    }
    button:hover { background: #0056b3; }

    .hidden { display: none !important; }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    th, td {
      padding: 10px;
      border-bottom: 1px solid #ddd;
      text-align: center;
    }

    th { background: #007BFF; color: white; }

    .live { color: green; font-weight: bold; }
    .upcoming { color: #0d6efd; font-weight: bold; }
    .completed { color: #6c757d; font-weight: bold; }

    .delete {
      background: #dc3545;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
    }

    .admin-btn { background: #6c757d; margin-top: 30px; }

    /* üîê MODAL */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal-box {
      background: #fff;
      padding: 25px;
      border-radius: 12px;
      width: 320px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
      text-align: center;
    }

    /* üîî INSIGHT TOAST */
    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #212529;
      color: white;
      padding: 12px 18px;
      border-radius: 10px;
      font-size: 0.95rem;
      box-shadow: 0 8px 20px rgba(0,0,0,0.3);
      z-index: 999;
      max-width: 90%;
      text-align: center;
      transition: opacity 0.4s ease, transform 0.4s ease;
    }

    .toast.hidden {
      opacity: 0;
      pointer-events: none;
      transform: translateX(-50%) translateY(10px);
    }
  </style>
</head>

<body>

<!-- USER VIEW -->
<div class="container" id="userView">
  <h2>üß∫ Laundry Slot Booking H-8</h2>

  <form id="bookingForm">
    <label>Name</label>
    <input id="userName" required>

    <label>Date</label>
    <input type="date" id="bookingDate" required>

    <label>Big Washer</label>
    <select id="bigWasher"></select>

    <label>Small Washer</label>
    <select id="smallWasher"></select>

    <label>Big Dryer</label>
    <select id="bigDryer"></select>

    <label>Small Dryer</label>
    <select id="smallDryer"></select>

    <button type="submit">‚úÖ Book Slot</button>
  </form>

  <button class="admin-btn" id="adminLoginBtn">üîê Admin Login</button>
</div>

<!-- ADMIN VIEW -->
<div class="container hidden" id="adminView">
  <h2>üõ†Ô∏è Admin Dashboard</h2>
  <label>Select Date</label>
  <input type="date" id="adminDate">
  <table>
    <thead>
      <tr>
        <th>Name</th><th>Machine</th><th>Slot</th><th>Status</th><th>Action</th>
      </tr>
    </thead>
    <tbody id="adminTable"></tbody>
  </table>
  <button class="admin-btn" onclick="logoutAdmin()">‚¨Ö Back to User</button>
</div>

<!-- ADMIN LOGIN MODAL -->
<div class="modal hidden" id="passwordModal">
  <div class="modal-box">
    <h3>Admin Login</h3>
    <input type="password" id="adminPassword" placeholder="Enter admin password"/>
    <button id="confirmAdminLogin">Login</button>
  </div>
</div>

<!-- üîî INSIGHT TOAST -->
<div id="insightToast" class="toast hidden"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
import { getDatabase, ref, push, get, child, update, remove } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBfU-aqLYHF_X0Rwv0WqZtB_M0cdacoDg",
  authDomain: "launry-booking-h8.firebaseapp.com",
  databaseURL: "https://launry-booking-h8-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "launry-booking-h8",
  storageBucket: "launry-booking-h8.appspot.com",
  messagingSenderId: "485927717258",
  appId: "1:485927717258:web:be15abc9f8cd281846e073"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const modal = document.getElementById("passwordModal");
modal.classList.add("hidden");

const today = new Date().toLocaleDateString("en-CA");
const currentMonth = today.slice(0,7);

const fields = ["bigWasher","smallWasher","bigDryer","smallDryer"];

const timeSlots = Array.from({length:24},(_,i)=>{
  const s = String(i).padStart(2,"0")+":00";
  const e = String((i+1)%24).padStart(2,"0")+":00";
  return `${s} - ${e}`;
});

function populateSlots() {
  fields.forEach(f=>{
    const sel=document.getElementById(f);
    sel.innerHTML='<option value="">-- Select Slot --</option>';
    timeSlots.forEach(slot=>{
      const o=document.createElement("option");
      o.value=o.textContent=slot;
      sel.appendChild(o);
    });
  });
}
populateSlots();

/* üîî MONTHLY INSIGHTS (OPTION A) */
async function loadMonthlyInsights() {
  const snap = await get(ref(db,"bookings"));
  if (!snap.exists()) return;

  const night={}, early={}, total={};
  let totalSlots=0;

  Object.values(snap.val()).forEach(day=>{
    Object.values(day).forEach(b=>{
      if(!b.date.startsWith(currentMonth)) return;
      fields.forEach(f=>{
        if(!b[f]) return;
        totalSlots++;
        const hour=parseInt(b[f].split(":")[0]);
        if(hour>=0 && hour<5){
          night[b.name]=(night[b.name]||0)+1;
        }
        if(hour>=5 && hour<7){
          early[b.name]=(early[b.name]||0)+1;
        }
        total[f]=(total[f]||0)+1;
      });
    });
  });

  const max=(obj)=>Object.entries(obj).sort((a,b)=>b[1]-a[1])[0];

  const insights=[];
  if(totalSlots===0){
    insights.push("‚ú® Be the first one to do laundry this month!");
  } else {
    if(max(night)) insights.push(`ü¶â Night Owl of the month: ${max(night)[0]} (${max(night)[1]} late-night washes)`);
    if(max(early)) insights.push(`üêì Early Bird of the month: ${max(early)[0]} (${max(early)[1]} sunrise washes)`);
    if(max(total)) insights.push(`üèÜ ${max(total)[0]} is the most used machine this month`);
    insights.push(`üß∫ Total laundry slots booked this month: ${totalSlots}`);
  }
  rotateInsights(insights);
}

let insightIndex=0;
function rotateInsights(insights){
  const toast=document.getElementById("insightToast");
  setInterval(()=>{
    toast.innerText=insights[insightIndex%insights.length];
    toast.classList.remove("hidden");
    setTimeout(()=>toast.classList.add("hidden"),3500);
    insightIndex++;
  },5000);
}

loadMonthlyInsights();
</script>

</body>
</html>
