<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Laundry Slot Booking H-8</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #f0f4ff, #e1ecff);
      margin: 0;
    }

    .page {
      display: flex;
      gap: 20px;
      align-items: flex-start;
      max-width: 1200px;
      margin: auto;
    }

    .container {
      flex: 1;
      background: #fff;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
      margin: 30px 0;
    }

    .side-metrics {
      width: 280px;
      background: #ffffff;
      padding: 20px;
      border-radius: 15px;
      margin-top: 30px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
      position: sticky;
      top: 20px;
    }

    .side-metrics h3 {
      margin-top: 0;
      text-align: center;
    }

    .metric {
      background: #f8f9fa;
      padding: 12px;
      border-radius: 10px;
      margin-bottom: 12px;
      font-size: 0.95rem;
    }

    label { font-weight: 600; margin-top: 15px; display: block; }

    input, select, button {
      width: 100%;
      padding: 10px;
      margin-top: 6px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-family: 'Poppins', sans-serif;
    }

    button {
      background: #007BFF;
      color: white;
      font-weight: 600;
      border: none;
      cursor: pointer;
      margin-top: 20px;
    }

    .admin-btn { background: #6c757d; }

    .hidden { display: none !important; }

    /* TOAST */
    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #212529;
      color: white;
      padding: 12px 18px;
      border-radius: 10px;
      font-size: 0.95rem;
      box-shadow: 0 8px 20px rgba(0,0,0,0.3);
      z-index: 999;
      transition: opacity 0.4s ease;
    }

    .toast.hidden { opacity: 0; pointer-events: none; }

  </style>
</head>

<body>

<div class="page">

  <!-- MAIN USER VIEW -->
  <div class="container" id="userView">
    <h2>üß∫ Laundry Slot Booking H-8</h2>

    <form id="bookingForm">
      <label>Name</label>
      <input id="userName" required>

      <label>Date</label>
      <input type="date" id="bookingDate" required>

      <label>Big Washer</label>
      <select id="bigWasher"></select>

      <label>Small Washer</label>
      <select id="smallWasher"></select>

      <label>Big Dryer</label>
      <select id="bigDryer"></select>

      <label>Small Dryer</label>
      <select id="smallDryer"></select>

      <button type="submit">‚úÖ Book Slot</button>
    </form>

    <button class="admin-btn" id="adminLoginBtn">üîê Admin Login</button>
  </div>

  <!-- SIDE METRICS -->
  <div class="side-metrics">
    <h3>üèÜ Laundry Legends</h3>

    <div class="metric" id="topMonth">
      üèÖ Top Booker (This Month): ‚Äî
    </div>

    <div class="metric" id="topAllTime">
      üåü All-Time Legend: ‚Äî
    </div>
  </div>

</div>

<!-- TOAST -->
<div id="insightToast" class="toast hidden"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
import { getDatabase, ref, push, get, child } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBfU-aqLYHF_X0Rwv0WqZtB_M0cdacoDg",
  authDomain: "launry-booking-h8.firebaseapp.com",
  databaseURL: "https://launry-booking-h8-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "launry-booking-h8",
  storageBucket: "launry-booking-h8.appspot.com",
  messagingSenderId: "485927717258",
  appId: "1:485927717258:web:be15abc9f8cd281846e073"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const fields = ["bigWasher","smallWasher","bigDryer","smallDryer"];
const today = new Date().toLocaleDateString("en-CA");
const month = today.slice(0,7);

/* ---------- TIME SLOTS ---------- */
const timeSlots = Array.from({length:24},(_,i)=>{
  const s = String(i).padStart(2,"0")+":00";
  const e = String((i+1)%24).padStart(2,"0")+":00";
  return `${s} - ${e}`;
});

fields.forEach(f=>{
  const sel=document.getElementById(f);
  sel.innerHTML='<option value="">-- Select Slot --</option>';
  timeSlots.forEach(slot=>{
    const o=document.createElement("option");
    o.value=o.textContent=slot;
    sel.appendChild(o);
  });
});

/* ---------- BOOKING ---------- */
bookingDate.value = today;
bookingForm.addEventListener("submit",async e=>{
  e.preventDefault();
  await push(ref(db,`bookings/${bookingDate.value}`),{
    name:userName.value,
    date:bookingDate.value,
    bigWasher:bigWasher.value,
    smallWasher:smallWasher.value,
    bigDryer:bigDryer.value,
    smallDryer:smallDryer.value
  });
  alert("‚úÖ Booking Successful");
  bookingForm.reset();
});

/* ---------- METRICS + INSIGHTS ---------- */
async function loadMetrics(){
  const snap = await get(ref(db,"bookings"));
  if(!snap.exists()) return;

  const monthly={}, allTime={}, night={}, early={};

  Object.values(snap.val()).forEach(day=>{
    Object.values(day).forEach(b=>{
      fields.forEach(f=>{
        if(!b[f]) return;
        allTime[b.name]=(allTime[b.name]||0)+1;
        if(b.date.startsWith(month)){
          monthly[b.name]=(monthly[b.name]||0)+1;
          const h=parseInt(b[f]);
          if(h<5) night[b.name]=(night[b.name]||0)+1;
          if(h>=5 && h<7) early[b.name]=(early[b.name]||0)+1;
        }
      });
    });
  });

  const max=o=>Object.entries(o).sort((a,b)=>b[1]-a[1])[0];

  if(max(monthly))
    document.getElementById("topMonth").innerText =
      `üèÖ Top Booker (This Month): ${max(monthly)[0]} (${max(monthly)[1]})`;

  if(max(allTime))
    document.getElementById("topAllTime").innerText =
      `üåü All-Time Legend: ${max(allTime)[0]} (${max(allTime)[1]})`;

  const insights=[];
  if(max(night)) insights.push(`ü¶â Night Owl of the Month: ${max(night)[0]}`);
  if(max(early)) insights.push(`üêì Early Bird of the Month: ${max(early)[0]}`);

  rotateInsights(insights);
}

/* ---------- ROTATING TOAST ---------- */
let idx=0;
function rotateInsights(arr){
  if(!arr.length) return;
  setInterval(()=>{
    insightToast.innerText=arr[idx%arr.length];
    insightToast.classList.remove("hidden");
    setTimeout(()=>insightToast.classList.add("hidden"),3500);
    idx++;
  },5000);
}

loadMetrics();
</script>

</body>
</html>
